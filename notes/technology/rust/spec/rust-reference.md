---
slug: /rust-reference
sidebar_label: 参照
---

# 【Rust】参照

**参照**は、所有権を持たないポインタ型で、参照先の生存期間に何の影響も与えません。また、ある値に対する参照を作ることを**借用**といいます。参照は次の2種類があります:

<dl>
<dt><strong>共有参照</strong></dt>

<dd>参照先を読むことはできるが変更することも移動することもできない。しかし、ある値に対する共有参照は、同時にいくらでも持つことができる。<code>&e</code> は、値 <code>e</code> 
に対する共有参照を返す。<code>e</code> の型が <code>T</code> であれば、<code>&e</code> の型は <code>&T</code> となる。
共有参照は Copy 型である。</dd>

<dt><strong>可変参照</strong></dt>

<dd>値を読み出すことも変更することもでき
る。しかし、同じ値に対する可変参照と、他の参照（共有参照でも可変参照でも）とは同時に使用することはできない。<code>&mut e</code> は、値 <code>e</code> に対する可変参照を返す。この参照の型は  <code>&mut T</code> となる。可変参照はCopy 型ではない。</dd>
</dl>

```rust 
// 【共有参照】
let mut x = 10;
let r1 = &x;
let r2 = &x;     // OK: 複数の共有参照は可能
x += 10;         // ERROR: x は借用されているので代入することはできない
let m = &mut x;  // ERROR: x は既に共有参照として借用されているので、
                 // 可変参照として借用することはできない

// 【可変参照】
let mut y = 20;
let m1 = &mut y;
let m2 = &mut y;  // ERROR: 可変参照は1度しか借用できない
let z = y;        // ERROR: y は可変で借用されているので、使えない
```

## 参照のルール

### 参照の代入

参照へ代入すると、参照は新しい値を指すようになります:

```rust 
let x = 10;
let y =20;
let mut r = &x;
// この時点で r は x を指す
r = &y;
// この時点で r は y を指す
```

### 参照への参照

参照への参照は値まで遡ります:

```rust 
struct Point { x: i32, y: i32 }
let point = Point { x: 1000, y: 729 };
let r: &Point = &point;
let rr: &&Point = &r;
let rrr: &&&Point = &rr;
// rrr.y は 729 である
```

### 参照の比較

参照を比較（`==`, `<`, `>=` など）する際は、参照元のアドレスではなく最終的な参照先の値が比較されます。参照元のアドレスを比較したい場合は、`std::ptr::eq()` を使用します。

## 仮引数として参照を受け取る場合の生存期間

次のコードでは、`STASH` の生存期間がグローバルなので、`p` の生存期間もグローバルでなければ、`STASH` はぶら下がりポインタとなってしまいます。そのため、コンパイルエラーとなります:

```rust
static mut STASH: &i32 = &128;
fn f(p: &i32) {
    unsafe {  // 可変な static に対しては unsafe ブロックからしかアクセスできない
        STASH = p;
    }
}
```

このような状況では、関数 `f` の定義の際、 `p` の生存期間をグローバルに限定することを明示する必要があります:

```rust {2}
static mut STASH: &i32 = &128;
fn f(p: &'static i32) {
    unsafe {  // 可変な static に対しては unsafe ブロックからしかアクセスできない
        STASH = p;
    }
}
```

`fn f<'a>(p: &'a T) { ... }` とすることで、`p` は、「任意の生存期間 `'a`（「tick A」と発音する）を持つ `T` への参照をに限定することを明示します。